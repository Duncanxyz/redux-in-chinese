<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Redux 中文官网 Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Redux 中文官网 Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-66122997-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Redux 中文官网" href="/opensearch.xml"><title data-react-helmet="true">服务端渲染 | Redux 中文官网</title><meta data-react-helmet="true" property="og:url" content="http://cn.redux.js.org/recipes/server-rendering"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="服务端渲染 | Redux 中文官网"><meta data-react-helmet="true" name="description" content="服务端渲染一个很常见的场景是当用户（或搜索引擎爬虫）第一次请求页面时，用它来做初始渲染。当服务器接收到请求后，它把需要的组件渲染成 HTML 字符串，然后把它返回给客户端（这里统指浏览器）。之后，客户端会接手渲染控制权。"><meta data-react-helmet="true" property="og:description" content="服务端渲染一个很常见的场景是当用户（或搜索引擎爬虫）第一次请求页面时，用它来做初始渲染。当服务器接收到请求后，它把需要的组件渲染成 HTML 字符串，然后把它返回给客户端（这里统指浏览器）。之后，客户端会接手渲染控制权。"><meta data-react-helmet="true" property="og:image" content="http://cn.redux.js.org/img/redux-logo-landscape.png"><meta data-react-helmet="true" name="twitter:image" content="http://cn.redux.js.org/img/redux-logo-landscape.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://cn.redux.js.org/recipes/server-rendering"><link data-react-helmet="true" rel="alternate" href="http://cn.redux.js.org/recipes/server-rendering" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://cn.redux.js.org/recipes/server-rendering" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.a0cae3ae.css">
<link rel="preload" href="/assets/js/runtime~main.9044bd3c.js" as="script">
<link rel="preload" href="/assets/js/main.983ddc03.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/redux.svg" alt="Redux Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/redux.svg" alt="Redux Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Redux 中文官网</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/introduction/getting-started">入门</a><a class="navbar__item navbar__link" href="/tutorials/essentials/part-1-overview-concepts">教程</a><a class="navbar__item navbar__link" href="/api/api-reference">API</a><a class="navbar__item navbar__link" href="/faq">常见问题</a><a class="navbar__item navbar__link" href="/style-guide/style-guide">最佳实践</a><a href="https://www.github.com/camsong/redux-in-chinese" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">源码</a><a href="https://github.com/camsong/redux-in-chinese/issues" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">纠错</a><div class="react-toggle displayOnlyInLargeViewport_cxYs react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/redux.svg" alt="Redux Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/redux.svg" alt="Redux Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><strong class="navbar__title">Redux 中文官网</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/introduction/getting-started">入门</a></li><li class="menu__list-item"><a class="menu__link" href="/tutorials/essentials/part-1-overview-concepts">教程</a></li><li class="menu__list-item"><a class="menu__link" href="/api/api-reference">API</a></li><li class="menu__list-item"><a class="menu__link" href="/faq">常见问题</a></li><li class="menu__list-item"><a class="menu__link" href="/style-guide/style-guide">最佳实践</a></li><li class="menu__list-item"><a href="https://www.github.com/camsong/redux-in-chinese" target="_blank" rel="noopener noreferrer" class="menu__link">源码</a></li><li class="menu__list-item"><a href="https://github.com/camsong/redux-in-chinese/issues" target="_blank" rel="noopener noreferrer" class="menu__link">纠错</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><div class="docSidebarContainer_0YBq" role="complementary"><div class="sidebar_a3j0"><div class="menu menu--responsive thin-scrollbar menu_cyFh"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_iZzd" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">简介</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/introduction/getting-started">入门 Redux</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/introduction/installation">安装</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/introduction/core-concepts">核心概念</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/introduction/learning-resources">学习资源</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/introduction/ecosystem">生态</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/introduction/examples">示例</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">教程</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/index">教程目录</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Redux 循序渐进</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/essentials/part-1-overview-concepts">基础概念</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/essentials/part-2-app-structure">应用结构</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/essentials/part-3-data-flow">数据流基础</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/essentials/part-4-using-data">使用数据</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/essentials/part-5-async-logic">异步逻辑与数据请求</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/essentials/part-6-performance-normalization">性能与数据范式化</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Redux 深入浅出</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/fundamentals/part-1-overview">Redux 概览</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/fundamentals/part-2-concepts-data-flow">Redux 概念与数据流</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/fundamentals/part-3-state-actions-reducers">State, Actions, and Reducers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/fundamentals/part-4-store">Store</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/fundamentals/part-5-ui-react">UI and React</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/fundamentals/part-6-async-logic">Async Logic and Data Fetching</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/fundamentals/part-7-standard-patterns">标准 Redux 模式</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tutorials/fundamentals/part-8-modern-redux">Modern Redux with Redux Toolkit</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">技巧</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/recipe-index">技巧</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/configuring-your-store">配置 Store</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/usage-with-typescript">Usage with TypeScript</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/migrating-to-redux">迁移到 Redux</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/using-object-spread-operator">使用对象展开运算符</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/reducing-boilerplate">减少样板代码</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/recipes/server-rendering">服务端渲染</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/writing-tests">编写测试</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/computing-derived-data">计算衍生数据</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/implementing-undo-history">实现撤销重做</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/isolating-redux-sub-apps">子应用隔离</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/code-splitting">代码分割</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/recipes/troubleshooting">Troubleshooting</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">组织 Reducers</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/structuring-reducers">组织 Reducer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/prerequisite-concepts">Reducer 必备概念</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/basic-reducer-structure">Reducer 和 State 的基本结构</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/splitting-reducer-logic">拆分 Reducer 逻辑</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/refactoring-reducer-example">重构 Reducer：基于函数分解（Functional Decomposition）和 Reducer 组合</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/using-combinereducers">`combineReducers` 用法</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/beyond-combinereducers">`combineReducers` 进阶</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/normalizing-state-shape">State 范式化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/updating-normalized-data">管理范式化数据</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/reusing-reducer-logic">Reducer 逻辑复用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/immutable-update-patterns">Immutable 不可变更新模式</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/recipes/structuring-reducers/initializing-state">初始化 State</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">深入理解 Redux</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">像 Redux 一样思考</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/understanding/thinking-in-redux/motivation">动机</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/understanding/thinking-in-redux/three-principles">三大原则</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/understanding/thinking-in-redux/glossary">词汇表</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">历史与设计原则</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/understanding/history-and-design/prior-art">先前技术</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/understanding/history-and-design/middleware">Middleware 中间件</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">常见问题</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq">Redux FAQ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/general">Redux FAQ: General</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/reducers">Redux FAQ: Reducers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/organizing-state">Redux FAQ: Organizing State</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/store-setup">Redux FAQ: Store Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/actions">Redux FAQ: Actions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/immutable-data">Redux FAQ: Immutable Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/code-structure">Redux FAQ: Code Structure</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/performance">Redux FAQ: Performance</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/design-decisions">Redux FAQ: Design Decisions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/react-redux">Redux FAQ: React Redux</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/faq/miscellaneous">Redux FAQ: Miscellaneous</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">编码规范</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/style-guide/style-guide">Style Guide: Best Practices</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">API 文档</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/api/api-reference">API Reference</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/api/createstore">createStore</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/api/store">Store</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/api/combinereducers">combineReducers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/api/applymiddleware">applyMiddleware</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/api/bindactioncreators">bindActionCreators</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/api/compose">compose</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Redux Toolkit</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/redux-toolkit/overview">Redux Toolkit: 概览</a></li></ul></li></ul></div></div></div><main class="docMainContainer_r8cw"><div class="container padding-vert--lg docItemWrapper_NJLN"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">服务端渲染</h1></header><div class="markdown"><p>服务端渲染一个很常见的场景是当用户（或搜索引擎爬虫）第一次请求页面时，用它来做<em>初始渲染</em>。当服务器接收到请求后，它把需要的组件渲染成 HTML 字符串，然后把它返回给客户端（这里统指浏览器）。之后，客户端会接手渲染控制权。</p><p>下面我们使用 React 来做示例，对于支持服务端渲染的其它 view 框架，做法也是类似的。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="服务端使用-redux"></a>服务端使用 Redux<a class="hash-link" href="#服务端使用-redux" title="Direct link to heading">#</a></h3><p>当在服务器使用 Redux 渲染时，一定要在响应中包含应用的 state，这样客户端可以把它作为初始 state。这点至关重要，因为如果在生成 HTML 前预加载了数据，我们希望客户端也能访问这些数据。否则，客户端生成的 HTML 与服务器端返回的 HTML 就会不匹配，客户端还需要重新加载数据。</p><p>把数据发送到客户端，需要以下步骤：</p><ul><li>为每次请求创建全新的 Redux store 实例；</li><li>按需 dispatch 一些 action；</li><li>从 store 中取出 state；</li><li>把 state 一同返回给客户端。</li></ul><p>在客户端，使用服务器返回的 state 创建并初始化一个全新的 Redux store。<br>
Redux 在服务端<strong>惟一</strong>要做的事情就是，提供应用所需的<strong>初始 state</strong>。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="安装"></a>安装<a class="hash-link" href="#安装" title="Direct link to heading">#</a></h2><p>下面来介绍如何配置服务端渲染。使用极简的 <a href="https://github.com/reduxjs/redux/tree/master/examples/counter" target="_blank" rel="noopener noreferrer">Counter 计数器应用</a> 来做示例，介绍如何根据请求在服务端提前渲染 state。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="安装依赖库"></a>安装依赖库<a class="hash-link" href="#安装依赖库" title="Direct link to heading">#</a></h3><p>本例会使用 <a href="http://expressjs.com/" target="_blank" rel="noopener noreferrer">Express</a> 来做小型的 web 服务器。还需要安装 Redux 对 React 的绑定库，Redux 默认并不包含。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><div tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token plain">npm install --save express react-redux</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="服务端开发"></a>服务端开发<a class="hash-link" href="#服务端开发" title="Direct link to heading">#</a></h2><p>下面是服务端代码大概的样子。使用 <a href="http://expressjs.com/api.html#app.use" target="_blank" rel="noopener noreferrer">app.use</a> 挂载 <a href="http://expressjs.com/guide/using-middleware.html" target="_blank" rel="noopener noreferrer">Express middleware</a> 处理所有请求。如果你还不熟悉 Express 或者 middleware，只需要了解每次服务器收到请求时都会调用 handleRender 函数。</p><p>另外，如果有使用 ES6 和 JSX 语法，需要使用 <a href="https://babeljs.io/" target="_blank" rel="noopener noreferrer">Babel</a> (对应示例<a href="https://github.com/babel/example-node-server" target="_blank" rel="noopener noreferrer">this example of a Node Server with Babel</a>) 和 <a href="https://babeljs.io/docs/plugins/preset-react/" target="_blank" rel="noopener noreferrer">React preset</a>。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="serverjs"></a><code>server.js</code><a class="hash-link" href="#serverjs" title="Direct link to heading">#</a></h5><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><div tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports">path</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;path&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Express</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;express&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> createStore </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;redux&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Provider</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react-redux&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports">counterApp</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./reducers&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">App</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./containers/App&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> app </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#E6D874">Express</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> port </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token number" style="color:#AE81FF">3000</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// 提供静态文件</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">app</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">use</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;/static&#x27;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token maybe-class-name">Express</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">static</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;static&#x27;</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// 每当收到请求时都会触发</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">app</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">use</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">handleRender</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// 接下来会补充这部分代码</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">handleRender</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#F8F8F2">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">/* ... */</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">renderFullPage</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">html</span><span class="token parameter punctuation" style="color:#F8F8F2">,</span><span class="token parameter"> preloadedState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">/* ... */</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">app</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">listen</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">port</span><span class="token punctuation" style="color:#F8F8F2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="处理请求"></a>处理请求<a class="hash-link" href="#处理请求" title="Direct link to heading">#</a></h3><p>第一件要做的事情就是对每个请求创建一个新的 Redux store 实例。这个 store 惟一作用是提供应用初始的 state。</p><p>渲染时，使用 <code>&lt;Provider&gt;</code> 来包住根组件 <code>&lt;App /&gt;</code>，以此来让组件树中所有组件都能访问到 store，就像之前的<a href="/tutorials/fundamentals/part-5-ui-react">搭配 React</a> 教程讲的那样。</p><p>服务端渲染最关键的一步是在<strong>发送响应前</strong>渲染初始的 HTML。这就要使用 <a href="https://facebook.github.io/react/docs/react-dom-server.html#rendertostring" target="_blank" rel="noopener noreferrer">ReactDOMServer.renderToString()</a>。</p><p>然后使用 <a href="/api/store#getState"><code>store.getState()</code></a> 从 store 得到初始 state。<code>renderFullPage</code> 函数会介绍接下来如何传递。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><div tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> renderToString </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react-dom/server&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">handleRender</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#F8F8F2">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 创建新的 Redux store 实例</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> store </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createStore</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">counterApp</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 把组件渲染成字符串</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> html </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">renderToString</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">Provider</span><span class="token plain"> store</span><span class="token operator" style="color:#F8F8F2">=</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain">store</span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">/</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token operator" style="color:#F8F8F2">/</span><span class="token maybe-class-name">Provider</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 从 store 中获得初始 state</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> preloadedState </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> store</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">getState</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 把渲染后的页面内容发送给客户端</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  res</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">send</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">renderFullPage</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">html</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> preloadedState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="注入初始组件的-html-和-state"></a>注入初始组件的 HTML 和 State<a class="hash-link" href="#注入初始组件的-html-和-state" title="Direct link to heading">#</a></h3><p>服务端最后一步就是把初始组件的 HTML 和初始 state 注入到客户端能够渲染的模板中。如何传递 state 呢，我们添加一个 <code>&lt;script&gt;</code> 标签来把 <code>preloadedState</code> 赋给 <code>window.__PRELOADED_STATE__</code>。</p><p>客户端可以通过 <code>window.__PRELOADED_STATE__</code> 获取 <code>preloadedState</code>。</p><p>同时使用 script 标签来引入打包后的 js bundle 文件。这是打包工具输出的客户端入口文件，以静态文件或者 URL 的方式实现服务端开发中的热加载。下面是代码。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><div tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">renderFullPage</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">html</span><span class="token parameter punctuation" style="color:#F8F8F2">,</span><span class="token parameter"> preloadedState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#F92672">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token template-string string" style="color:#a6e22e"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">    &lt;!doctype html&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">    &lt;html&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">      &lt;head&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">        &lt;title&gt;Redux Universal Example&lt;/title&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">      &lt;/head&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">      &lt;body&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">        &lt;div id=&quot;root&quot;&gt;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation">html</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string string" style="color:#a6e22e">&lt;/div&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">        &lt;script&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">          // 警告：关于在 HTML 中嵌入 JSON 的安全问题，请查看以下文档</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">          // http://redux.js.org/recipes/ServerRendering.html#security-considerations</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">          window.__PRELOADED_STATE__ = </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">${</span><span class="token template-string interpolation known-class-name class-name">JSON</span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">.</span><span class="token template-string interpolation method function property-access" style="color:#E6D874">stringify</span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">(</span><span class="token template-string interpolation">preloadedState</span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">)</span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">.</span><span class="token template-string interpolation method function property-access" style="color:#E6D874">replace</span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">(</span><span class="token template-string interpolation"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string interpolation">            </span><span class="token template-string interpolation regex regex-delimiter" style="color:#FD971F">/</span><span class="token template-string interpolation regex regex-source language-regex" style="color:#FD971F">&lt;</span><span class="token template-string interpolation regex regex-delimiter" style="color:#FD971F">/</span><span class="token template-string interpolation regex regex-flags" style="color:#FD971F">g</span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">,</span><span class="token template-string interpolation"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string interpolation">            </span><span class="token template-string interpolation string" style="color:#a6e22e">&#x27;\\u003c&#x27;</span><span class="token template-string interpolation"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string interpolation">          </span><span class="token template-string interpolation punctuation" style="color:#F8F8F2">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#F8F8F2">}</span><span class="token template-string string" style="color:#a6e22e"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">        &lt;/script&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">        &lt;script src=&quot;/static/bundle.js&quot;&gt;&lt;/script&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">      &lt;/body&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">    &lt;/html&gt;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token template-string string" style="color:#a6e22e">    </span><span class="token template-string template-punctuation string" style="color:#a6e22e">`</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="客户端开发"></a>客户端开发<a class="hash-link" href="#客户端开发" title="Direct link to heading">#</a></h2><p>客户端代码非常直观。只需要从 <code>window.__PRELOADED_STATE__</code> 得到初始 state，并传给 <a href="/api/createstore"><code>createStore()</code></a> 函数即可。</p><p>代码如下:</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="clientjs"></a><code>client.js</code><a class="hash-link" href="#clientjs" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><div tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> hydrate </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react-dom&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> createStore </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;redux&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Provider</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react-redux&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">App</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./containers/App&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports">counterApp</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./reducers&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// 通过服务端注入的全局变量得到初始 state</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> preloadedState </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#F8F8F2">window</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">__PRELOADED_STATE__</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// 让状态数据可以被垃圾回收</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">delete</span><span class="token plain"> </span><span class="token dom variable" style="color:#F8F8F2">window</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">__PRELOADED_STATE__</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#c6cad2">// 使用初始 state 创建 Redux store</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> store </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createStore</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">counterApp</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> preloadedState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token function" style="color:#E6D874">hydrate</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">Provider</span><span class="token plain"> store</span><span class="token operator" style="color:#F8F8F2">=</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain">store</span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">/</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token operator" style="color:#F8F8F2">/</span><span class="token maybe-class-name">Provider</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token dom variable" style="color:#F8F8F2">document</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">getElementById</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token string" style="color:#a6e22e">&#x27;root&#x27;</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>你可以选择自己喜欢的打包工具（Webpack, Browserify 或其它）来编译并打包文件到 <code>static/bundle.js</code>。</p><p>当页面加载时，打包后的 js 会启动，并调用 <a href="https://reactjs.org/docs/react-dom.html#hydrate" target="_blank" rel="noopener noreferrer"><code>React.hydrate()</code></a>，然后会与服务端渲染的 HTML 的 <code>data-react-id</code> 属性做关联。这会把新生成的 React 实例与服务端的虚拟 DOM 连接起来。因为同样使用了来自 Redux store 的初始 state，并且 view 组件代码是一样的，结果就是我们得到了相同的 DOM。</p><p>就是这样！这就是实现服务端渲染的所有步骤。</p><p>但这样做还是比较原始的。只会用动态代码渲染一个静态的 View。下一步要做的是动态创建初始 state 支持动态渲染 view。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="准备初始-state"></a>准备初始 State<a class="hash-link" href="#准备初始-state" title="Direct link to heading">#</a></h2><p>因为客户端只是执行收到的代码，刚开始的初始 state 可能是空的，然后根据需要获取 state。在服务端，渲染是同步执行的而且我们只有一次渲染 view 的机会。在收到请求时，可能需要根据请求参数或者外部 state（如访问 API 或者数据库），计算后得到初始 state。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="处理-request-参数"></a>处理 Request 参数<a class="hash-link" href="#处理-request-参数" title="Direct link to heading">#</a></h3><p>服务端收到的唯一输入是来自浏览器的请求。在服务器启动时可能需要做一些配置（如运行在开发环境还是生产环境），但这些配置是静态的。</p><p>请求会包含 URL 请求相关信息，包括请求参数，它们对于做 <a href="https://github.com/ReactTraining/react-router" target="_blank" rel="noopener noreferrer">React Router</a> 路由时可能会有用。也可能在请求头里包含 cookies，鉴权信息或者 POST 内容数据。下面演示如何基于请求参数来得到初始 state。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="serverjs-1"></a><code>server.js</code><a class="hash-link" href="#serverjs-1" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><div tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports">qs</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;qs&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#c6cad2">// 添加到文件开头</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> renderToString </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react-dom/server&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">handleRender</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#F8F8F2">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 如果存在的话，从 request 读取 counter</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> params </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> qs</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">parse</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> counter </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">parseInt</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">counter</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token number" style="color:#AE81FF">10</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">||</span><span class="token plain"> </span><span class="token number" style="color:#AE81FF">0</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 得到初始 state</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">let</span><span class="token plain"> preloadedState </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> counter </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 创建新的 Redux store 实例</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> store </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createStore</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">counterApp</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> preloadedState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 把组件渲染成字符串</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> html </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">renderToString</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">Provider</span><span class="token plain"> store</span><span class="token operator" style="color:#F8F8F2">=</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain">store</span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">/</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token operator" style="color:#F8F8F2">/</span><span class="token maybe-class-name">Provider</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 从 Redux store 得到初始 state</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> finalState </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> store</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">getState</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 把渲染后的页面发给客户端</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  res</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">send</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">renderFullPage</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">html</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> finalState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>上面的代码首先访问 Express 的 <code>Request</code> 对象。把参数转成数字，然后设置到初始 state 中。如果你在浏览器中访问 <a href="http://localhost:3000/?counter=100" target="_blank" rel="noopener noreferrer">http://localhost:3000/?counter=100</a>，你会看到计数器从 100 开始。在渲染后的 HTML 中，你会看到计数显示 100 同时设置进了 <code>__PRELOADED_STATE__</code> 变量。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="获取异步-state"></a>获取异步 State<a class="hash-link" href="#获取异步-state" title="Direct link to heading">#</a></h3><p>服务端渲染常用的场景是处理异步 state。因为服务端渲染天生是同步的，因此异步的数据获取操作对应到同步操作非常重要。</p><p>最简单的做法是往同步代码里传递一些回调函数。在这个回调函数里引用响应对象，把渲染后的 HTML 发给客户端。不要担心，并没有想像中那么难。</p><p>本例中，我们假设有一个外部数据源提供计算器的初始值（所谓的把计算作为一种服务）。我们会模拟一个请求并使用结果创建初始 state。API 请求代码如下：</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="apicounterjs"></a><code>api/counter.js</code><a class="hash-link" href="#apicounterjs" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><div tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">getRandomInt</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">min</span><span class="token parameter punctuation" style="color:#F8F8F2">,</span><span class="token parameter"> max</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#F92672">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">floor</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">random</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">max </span><span class="token operator" style="color:#F8F8F2">-</span><span class="token plain"> min</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">+</span><span class="token plain"> min</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">export</span><span class="token plain"> </span><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">fetchCounter</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">callback</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#E6D874">setTimeout</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#E6D874">callback</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">getRandomInt</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token number" style="color:#AE81FF">1</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token number" style="color:#AE81FF">100</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> </span><span class="token number" style="color:#AE81FF">500</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>再次说明一下，这只是一个模拟的 API，我们使用 <code>setTimeout</code> 模拟一个需要 500 毫秒的请求（实际项目中 API 请求一般会更快）。传入一个回调函数，它异步返回一个随机数字。如果你使用了基于 Promise 的 API 工具，那么要把回调函数放到 <code>then</code> 中。</p><p>在服务端，把代码使用 <code>fetchCounter</code> 包起来，在回调函数里拿到结果：</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="serverjs-2"></a><code>server.js</code><a class="hash-link" href="#serverjs-2" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI js"><div tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#272822"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#c6cad2">// 添加到 import</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> fetchCounter </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;./api/counter&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword module" style="color:#F92672">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#F8F8F2">{</span><span class="token imports"> renderToString </span><span class="token imports punctuation" style="color:#F8F8F2">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#F92672">from</span><span class="token plain"> </span><span class="token string" style="color:#a6e22e">&#x27;react-dom/server&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#F92672">function</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">handleRender</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#F8F8F2">,</span><span class="token parameter"> res</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#c6cad2">// 异步请求模拟的 API</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token function" style="color:#E6D874">fetchCounter</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token parameter">apiResult</span><span class="token plain"> </span><span class="token arrow operator" style="color:#F8F8F2">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// 如果存在的话，从 request 读取 counter</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> params </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> qs</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">parse</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> counter </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">parseInt</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token property-access">counter</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">||</span><span class="token plain"> apiResult </span><span class="token operator" style="color:#F8F8F2">||</span><span class="token plain"> </span><span class="token number" style="color:#AE81FF">0</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// 得到初始 state</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">let</span><span class="token plain"> preloadedState </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain"> counter </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// 创建新的 Redux store 实例</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> store </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">createStore</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">counterApp</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> preloadedState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// 把组件渲染成字符串</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> html </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> </span><span class="token function" style="color:#E6D874">renderToString</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">Provider</span><span class="token plain"> store</span><span class="token operator" style="color:#F8F8F2">=</span><span class="token punctuation" style="color:#F8F8F2">{</span><span class="token plain">store</span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator" style="color:#F8F8F2">/</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token operator" style="color:#F8F8F2">&lt;</span><span class="token operator" style="color:#F8F8F2">/</span><span class="token maybe-class-name">Provider</span><span class="token operator" style="color:#F8F8F2">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// 从 Redux store 得到初始 state</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#F92672">const</span><span class="token plain"> finalState </span><span class="token operator" style="color:#F8F8F2">=</span><span class="token plain"> store</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">getState</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#c6cad2">// 把渲染后的页面发给客户端</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    res</span><span class="token punctuation" style="color:#F8F8F2">.</span><span class="token method function property-access" style="color:#E6D874">send</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token function" style="color:#E6D874">renderFullPage</span><span class="token punctuation" style="color:#F8F8F2">(</span><span class="token plain">html</span><span class="token punctuation" style="color:#F8F8F2">,</span><span class="token plain"> finalState</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#F8F8F2">}</span><span class="token punctuation" style="color:#F8F8F2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#F8F8F2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>因为在回调中使用了 <code>res.send()</code>，服务器会保护连接打开并在回调函数执行前不发送任何数据。你会发现每个请求都有 500ms 的延时。更高级的用法会包括对 API 请求出错进行处理，比如错误的请求或者超时。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="安全注意事项"></a>安全注意事项<a class="hash-link" href="#安全注意事项" title="Direct link to heading">#</a></h3><p>因为我们代码中很多是基于用户生成内容（UGC）和输入的，不知不觉中，提高了应用可能受攻击区域。任何应用都应该对用户输入做安全处理以避免跨站脚本攻击（XSS）或者代码注入。</p><p>我们的示例中，只对安全做基本处理。当从请求中拿参数时，对 <code>counter</code> 参数使用 <code>parseInt</code> 把它转成数字。如果不这样做，当 request 中有 script 标签时，很容易在渲染的 HTML 中生成危险代码。就像这样的：<code>?counter=&lt;/script&gt;&lt;script&gt;doSomethingBad();&lt;/script&gt;</code></p><p>在我们极简的示例中，把输入转成数字已经比较安全。如果处理更复杂的输入，比如自定义格式的文本，你应该用安全函数处理输入，比如 <a href="https://github.com/yahoo/xss-filters" target="_blank" rel="noopener noreferrer">xss-filters</a>。</p><p>此外，你可以添加额外的安全层来对产生的 state 进行消毒。<code>JSON.stringify</code> 可能会造成 script 注入。鉴于此，你需要清洗 JSON 字符串中的 HTML 标签和其它危险的字符。可以通过字符串替换，例如<code>JSON.stringify(state).replace(/&lt;/g, &#x27;\\u003c&#x27;)</code>，或者使用复杂的库如 <a href="https://github.com/yahoo/serialize-javascript" target="_blank" rel="noopener noreferrer">serialize-javascript</a> 处理。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="下一步"></a>下一步<a class="hash-link" href="#下一步" title="Direct link to heading">#</a></h2><p>你还可以参考 <a href="/tutorials/fundamentals/part-6-async-logic">异步 Actions 与数据请求</a> 学习更多使用 Promise 和 thunk 这些异步元素来表示异步数据流的方法。记住，那里学到的任何内容都可以用于同构渲染。</p><p>如果您使用 <a href="https://github.com/ReactTraining/react-router" target="_blank" rel="noopener noreferrer">React Router</a> 之类的东西，您可能还想将数据获取依赖项表示为路由处理程序组件上的静态 <code>fetchData()</code> 方法。 他们可能会返回 <a href="/tutorials/fundamentals/part-6-async-logic">thunks</a>，以便您的 <code>handleRender</code> 函数可以匹配到对应的组件类，对它们均 dispatch <code>fetchData()</code> 的结果，在 Promise 解决后才渲染。这样不同路由需要调用的 API 请求都并置于路由处理组件了。在客户端，你也可以使用同样技术来避免在切换页面时，当数据还没有加载完成前执行路由。</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/recipes/reducing-boilerplate"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 减少样板代码</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/recipes/writing-tests"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">编写测试 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#服务端使用-redux" class="table-of-contents__link">服务端使用 Redux</a></li><li><a href="#安装" class="table-of-contents__link">安装</a><ul><li><a href="#安装依赖库" class="table-of-contents__link">安装依赖库</a></li></ul></li><li><a href="#服务端开发" class="table-of-contents__link">服务端开发</a><ul><li><a href="#处理请求" class="table-of-contents__link">处理请求</a></li><li><a href="#注入初始组件的-html-和-state" class="table-of-contents__link">注入初始组件的 HTML 和 State</a></li></ul></li><li><a href="#客户端开发" class="table-of-contents__link">客户端开发</a></li><li><a href="#准备初始-state" class="table-of-contents__link">准备初始 State</a><ul><li><a href="#处理-request-参数" class="table-of-contents__link">处理 Request 参数</a></li><li><a href="#获取异步-state" class="table-of-contents__link">获取异步 State</a></li><li><a href="#安全注意事项" class="table-of-contents__link">安全注意事项</a></li></ul></li><li><a href="#下一步" class="table-of-contents__link">下一步</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/introduction/getting-started">入门</a></li><li class="footer__item"><a class="footer__link-item" href="/tutorials/essentials/part-1-overview-concepts">教程</a></li><li class="footer__item"><a class="footer__link-item" href="/faq">常见问题</a></li><li class="footer__item"><a class="footer__link-item" href="/api/api-reference">API 文档</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">社区</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/0ZcbPKXt5bZ6au5t" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reactiflux Discord</a></li><li class="footer__item"><a href="http://stackoverflow.com/questions/tagged/redux" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a class="footer__link-item" href="/introduction/getting-started#help-and-discussion">Feedback</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/camsong/redux-in-chinese" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item">
                <a href="https://www.netlify.com">
                  <img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify">
                </a>
              </li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://redux.js.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_SRtH"><img src="/img/redux.svg" alt="Redux Logo" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/redux.svg" alt="Redux Logo" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">Copyright © 2015–2022 Dan Abramov and Cam Song.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9044bd3c.js"></script>
<script src="/assets/js/main.983ddc03.js"></script>
</body>
</html>